<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ product.name }} | SomaXpres</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f8fafc; }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ù†Ø§Ø¹Ù…Ø© */
        .glass-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .voice-wave .bar {
            width: 4px; height: 10px; background: #e11d48; border-radius: 10px; animation: bounce 0.5s infinite;
        }
        @keyframes bounce { 0%, 100% { height: 10px; } 50% { height: 25px; } }
    </style>
</head>
<body class="pb-32 antialiased text-slate-800">

    <div class="relative w-full bg-white shadow-sm overflow-hidden group">
        <div class="absolute top-4 right-4 z-10 bg-rose-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
            ØªØ®ÙÙŠØ¶ Ø­ØµØ±ÙŠ ğŸ”¥
        </div>
        
        <div class="flex overflow-x-auto snap-x snap-mandatory no-scrollbar" id="gallery">
            <img src="{{ product.image }}" class="snap-center w-full h-[400px] object-cover" alt="{{ product.name }}">
        </div>
        
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-1.5">
            <div class="w-2 h-2 rounded-full bg-slate-800 transition-all duration-300"></div>
            <div class="w-2 h-2 rounded-full bg-slate-300"></div>
        </div>
    </div>

    <main class="max-w-xl mx-auto">
        <div class="p-5 bg-white mb-2 shadow-sm rounded-b-3xl relative -mt-4 z-20">
            <div class="flex justify-between items-end mb-3">
                <div class="flex flex-col">
                    <span class="text-sm text-slate-400 line-through decoration-rose-500/50 decoration-2">
                        {{ (product.price|int * 1.3)|round|int }} Ø¯Ø¬
                    </span>
                    <span class="text-3xl font-black text-rose-600 leading-none">
                        {{ product.price }} <span class="text-sm font-bold text-slate-600">Ø¯Ø¬</span>
                    </span>
                </div>
                <div class="flex items-center gap-1 bg-amber-50 px-2 py-1 rounded-lg border border-amber-100">
                    <i class="fas fa-star text-amber-500 text-xs"></i>
                    <span class="text-xs font-bold text-amber-700">4.9</span>
                    <span class="text-[10px] text-slate-400">(+200 ØªÙ‚ÙŠÙŠÙ…)</span>
                </div>
            </div>

            <h1 class="text-xl font-bold text-slate-900 leading-snug mb-4">
                {{ product.name }}
            </h1>

            <div class="bg-slate-50 rounded-lg p-3 border border-slate-100">
                <div class="flex justify-between text-xs font-bold text-slate-600 mb-1">
                    <span>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
                    <span class="text-rose-600">8 Ù‚Ø·Ø¹ ÙÙ‚Ø·!</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                    <div class="bg-rose-500 h-2 rounded-full w-[85%] shadow-[0_0_10px_rgba(225,29,72,0.5)]"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 px-4 mb-2">
            <div class="bg-white p-3 rounded-2xl text-center shadow-sm border border-slate-50 flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center text-lg">
                    <i class="fas fa-truck-fast"></i>
                </div>
                <span class="text-[10px] font-bold text-slate-600 leading-tight">ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹<br>58 ÙˆÙ„Ø§ÙŠØ©</span>
            </div>
            <div class="bg-white p-3 rounded-2xl text-center shadow-sm border border-slate-50 flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-lg">
                    <i class="fas fa-shield-check"></i>
                </div>
                <span class="text-[10px] font-bold text-slate-600 leading-tight">Ø¶Ù…Ø§Ù†<br>Ø­Ù‚ÙŠÙ‚ÙŠ</span>
            </div>
            <div class="bg-white p-3 rounded-2xl text-center shadow-sm border border-slate-50 flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center text-lg">
                    <i class="fas fa-hand-holding-dollar"></i>
                </div>
                <span class="text-[10px] font-bold text-slate-600 leading-tight">Ø§Ù„Ø¯ÙØ¹<br>Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
            </div>
        </div>

        <div class="bg-white p-5 mb-2 shadow-sm">
            <h3 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
                <i class="fas fa-align-right text-rose-500"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
            </h3>
            <p class="text-sm text-slate-600 leading-7 whitespace-pre-line">
                {{ product.description }}
                <br><br>
                âœ… ØªØµÙ…ÙŠÙ… Ø£ØµÙ„ÙŠ ÙˆØ£Ù†ÙŠÙ‚.
                âœ… Ø¬ÙˆØ¯Ø© ØªØµÙ†ÙŠØ¹ Ø¹Ø§Ù„ÙŠØ©.
                âœ… Ø¶Ù…Ø§Ù† Ø§Ù„Ø±Ø¶Ø§ 100%.
            </p>
        </div>

    </main>

    <div class="fixed bottom-0 left-0 w-full glass-nav border-t border-slate-200/50 p-3 pb-safe z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <div class="max-w-xl mx-auto flex gap-3">
            <button onclick="openGateway()" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-rose-200 active:scale-95 transition-all flex items-center justify-center gap-2 relative overflow-hidden group">
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                <span>Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</span>
                <i class="fas fa-angle-left animate-pulse"></i>
            </button>
            
            <button class="w-14 bg-slate-100 text-slate-600 rounded-xl flex items-center justify-center border border-slate-200 hover:bg-slate-200 active:scale-95">
                <i class="fab fa-whatsapp text-xl text-green-600"></i>
            </button>
        </div>
    </div>

    <div id="gatewayPopup" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] hidden flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full sm:w-[400px] rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300 shadow-2xl" id="gatewayContent">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <h3 class="text-xl font-bold text-slate-800 text-center mb-1">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h3>
            <p class="text-slate-500 text-sm text-center mb-6">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø³Ø±Ø¹ Ù„Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨Ùƒ</p>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="startVoiceMode()" class="relative p-4 border border-slate-200 rounded-2xl hover:border-rose-500 hover:bg-rose-50 transition group overflow-hidden">
                    <div class="absolute top-2 left-2 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <div class="w-12 h-12 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-microphone text-lg"></i>
                    </div>
                    <div class="text-center">
                        <span class="block font-bold text-slate-800 text-sm">Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©</span>
                        <span class="text-[10px] text-rose-500 font-bold">Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ ğŸ”¥</span>
                    </div>
                </button>

                <button onclick="startTextMode()" class="p-4 border border-slate-200 rounded-2xl hover:border-blue-500 hover:bg-blue-50 transition group">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                        <i class="fas fa-comment-dots text-lg"></i>
                    </div>
                    <div class="text-center">
                        <span class="block font-bold text-slate-800 text-sm">Ù…Ø­Ø§Ø¯Ø«Ø© ÙƒØªØ§Ø¨ÙŠØ©</span>
                        <span class="text-[10px] text-slate-400">Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø§Ø¯ÙŠØ©</span>
                    </div>
                </button>
            </div>
            
            <button onclick="closeGateway()" class="mt-6 w-full py-3 text-slate-400 text-sm font-medium hover:text-slate-600 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="liveInterface" class="fixed inset-0 bg-white z-[70] hidden flex flex-col">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white shadow-sm z-10">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <img src="https://ui-avatars.com/api/?name=Amine&background=e11d48&color=fff" class="w-10 h-10 rounded-full border-2 border-white shadow-md">
                    <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800 text-sm" id="agentName">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Ø£Ù…ÙŠÙ†)</h3>
                    <p class="text-[10px] text-slate-500">ÙŠØ±Ø¯ ÙÙˆØ±Ø§Ù‹ âš¡</p>
                </div>
            </div>
            <button onclick="closeLive()" class="w-8 h-8 flex items-center justify-center bg-slate-50 hover:bg-slate-100 rounded-full text-slate-500 transition">âœ•</button>
        </div>

        <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50 scroll-smooth">
            </div>

        <div id="voiceControls" class="p-8 bg-white border-t border-slate-100 text-center hidden rounded-t-3xl shadow-[0_-5px_30px_rgba(0,0,0,0.03)]">
            <div id="waveAnimation" class="voice-wave opacity-0 mb-6 h-8 justify-center">
                <div class="bar"></div><div class="bar" style="animation-delay: 0.1s"></div><div class="bar" style="animation-delay: 0.2s"></div><div class="bar"></div>
            </div>
            <p id="statusText" class="text-sm font-bold text-slate-400 mb-6">Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ø« Ù„ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ</p>
            <button id="micBtn" class="w-20 h-20 bg-gradient-to-br from-rose-500 to-rose-600 text-white rounded-full shadow-xl shadow-rose-200 flex items-center justify-center mx-auto text-3xl active:scale-90 transition-transform ring-4 ring-rose-50">
                <i class="fas fa-microphone"></i>
            </button>
        </div>

        <div id="textControls" class="p-3 bg-white border-t border-slate-100 hidden">
            <div class="flex gap-2 items-center">
                <input type="text" id="textInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="flex-1 bg-slate-100 border-0 rounded-2xl px-5 py-3.5 text-sm focus:ring-2 focus:ring-rose-500 outline-none transition-all">
                <button onclick="sendMessage('text')" class="w-12 h-12 bg-rose-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-rose-700 active:scale-95 transition-all">
                    <i class="fas fa-paper-plane text-sm transform -translate-x-0.5 translate-y-0.5"></i>
                </button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" class="hidden"></audio>

    <script>
        // === Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø³Ø§Ø¨Ù‚ (ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…ÙŠØ²Ø§Øª) ===
        let conversationHistory = [];
        let isRecording = false;
        let recognition = null;

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'ar-DZ';
            
            recognition.onstart = function() {
                isRecording = true;
                document.getElementById('statusText').innerText = "Ø£Ù†Ø§ Ø£Ø³Ù…Ø¹Ùƒ...";
                document.getElementById('statusText').classList.add('text-rose-600');
                document.getElementById('waveAnimation').classList.remove('opacity-0');
            };

            recognition.onend = function() {
                isRecording = false;
                document.getElementById('statusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
                document.getElementById('statusText').classList.remove('text-rose-600');
                document.getElementById('waveAnimation').classList.add('opacity-0');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                addMessage('user', transcript);
                sendMessageToBackend(transcript, 'voice');
            };
        }

        document.getElementById('micBtn').onclick = function() {
            if (!isRecording && recognition) recognition.start();
        };

        function sendMessage(type) {
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            if (text) {
                addMessage('user', text);
                sendMessageToBackend(text, 'text');
                input.value = '';
            }
        }

        async function sendMessageToBackend(text, type) {
            const loadingId = addLoadingBubble();
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, history: conversationHistory, type: type })
                });
                const data = await response.json();
                removeLoadingBubble(loadingId);
                addMessage('ai', data.text);
                conversationHistory.push({role: "user", content: text});
                conversationHistory.push({role: "assistant", content: data.text});
                if (data.audio) playAudio(data.audio);
            } catch (error) {
                removeLoadingBubble(loadingId);
                addMessage('ai', "Ø³Ù…Ø­Ù„ÙŠØŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„.");
            }
        }

        function playAudio(base64Audio) {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = "data:audio/wav;base64," + base64Audio;
            audioPlayer.play();
        }

        function addMessage(sender, text) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            const isAI = sender === 'ai';
            div.className = `flex ${isAI ? 'justify-start' : 'justify-end'} animate-fade-in-up`;
            div.innerHTML = `
                <div class="max-w-[85%] p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ${isAI ? 'bg-white text-slate-700 border border-slate-100 rounded-tl-none' : 'bg-rose-600 text-white rounded-tr-none'}">
                    ${text}
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function addLoadingBubble() {
            const id = 'loading-' + Date.now();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex justify-start animate-fade-in-up';
            div.innerHTML = `<div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 flex gap-1"><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-100"></div><div class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-200"></div></div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return id;
        }

        function removeLoadingBubble(id) { const el = document.getElementById(id); if(el) el.remove(); }
        
        // Popups Logic
        function openGateway() { 
            const popup = document.getElementById('gatewayPopup');
            const content = document.getElementById('gatewayContent');
            popup.classList.remove('hidden'); 
            setTimeout(() => { 
                popup.classList.remove('opacity-0'); 
                content.classList.remove('translate-y-full'); 
            }, 10); 
        }
        
        function closeGateway() { 
            const popup = document.getElementById('gatewayPopup');
            const content = document.getElementById('gatewayContent');
            content.classList.add('translate-y-full'); 
            popup.classList.add('opacity-0'); 
            setTimeout(() => popup.classList.add('hidden'), 300); 
        }

        function startVoiceMode() { closeGateway(); document.getElementById('liveInterface').classList.remove('hidden'); document.getElementById('voiceControls').classList.remove('hidden'); document.getElementById('textControls').classList.add('hidden'); addMessage('ai', 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø£Ù…ÙŠÙ†. Ø±Ø§Ù†ÙŠ Ù‡Ù†Ø§ Ø¨Ø§Ø´ Ù†Ø£ÙƒØ¯Ù„Ùƒ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©. Ù‚ÙˆÙ„ÙŠ ÙˆÙŠÙ† ØªØ³ÙƒÙ† Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŸ'); } 
        function startTextMode() { closeGateway(); document.getElementById('liveInterface').classList.remove('hidden'); document.getElementById('voiceControls').classList.add('hidden'); document.getElementById('textControls').classList.remove('hidden'); addMessage('ai', 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø£Ù…ÙŠÙ†. Ø£ÙƒØªØ¨Ù„ÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØªØ§Ø¹Ùƒ.'); }
        function closeLive() { document.getElementById('liveInterface').classList.add('hidden'); }
    </script>
</body>
</html>
