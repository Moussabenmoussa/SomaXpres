{% extends "layout_dashboard.html" %}

{% block content %}
<div class="max-w-5xl mx-auto pb-20">
    
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">إضافة منتج (مواصفات AliExpress)</h2>
            <p class="text-sm text-gray-500">أدخل تفاصيل دقيقة لزيادة المبيعات.</p>
        </div>
        <div class="flex gap-2">
            <a href="/dashboard" class="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">إلغاء</a>
            <button type="submit" form="productForm" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-lg font-bold flex items-center gap-2">
                <i data-lucide="upload-cloud" class="w-4 h-4"></i> نشر الآن
            </button>
        </div>
    </div>

    <form id="productForm" action="/dashboard/products/new" method="POST" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- العمود الأيمن: البيانات الأساسية -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- 1. الصور (Multi-Upload) -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="image" class="text-blue-500"></i> صور المنتج
                </h3>
                
                <!-- منطقة الرفع -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition cursor-pointer relative" id="dropZone">
                    <input type="file" id="fileInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFiles(this.files)">
                    <div class="space-y-2">
                        <i data-lucide="upload" class="w-10 h-10 mx-auto text-gray-400"></i>
                        <p class="text-sm font-medium text-gray-600">اضغط لاختيار الصور أو اسحبها هنا</p>
                        <p class="text-xs text-gray-400">JPG, PNG, WEBP (Max 5MB)</p>
                    </div>
                </div>

                <!-- معاينة الصور (Gallery) -->
                <div id="galleryPreview" class="grid grid-cols-4 gap-4 mt-4"></div>
                
                <!-- حقل مخفي لتخزين الروابط وإرسالها للسيرفر -->
                <input type="hidden" name="images_list" id="imagesList">
            </div>

            <!-- 2. التفاصيل والسعر -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4">التفاصيل الأساسية</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">اسم المنتج (العنوان)</label>
                    <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" placeholder="مثلاً: ساعة ذكية Ultra T800 ضد الماء">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">السعر الحالي (دج)</label>
                        <input type="number" name="price" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-lg font-bold" placeholder="5500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">السعر قبل الخصم (وهمي)</label>
                        <input type="number" name="old_price" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-gray-500 line-through" placeholder="8500">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">الوصف الدقيق</label>
                    <textarea name="description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none" placeholder="اكتب وصفاً مفصلاً للمنتج..."></textarea>
                </div>
            </div>

            <!-- 3. المتغيرات (Colors & Sizes) -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i data-lucide="layers" class="text-purple-500"></i> الخيارات (Variants)
                    </h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- الألوان -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الألوان المتوفرة</label>
                        <input type="text" name="colors" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="أحمر, أزرق, أسود (افصل بفاصلة)">
                        <p class="text-xs text-gray-500 mt-1">اكتب الألوان وافصل بينها بفاصلة (,)</p>
                    </div>

                    <!-- المقاسات -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">المقاسات المتوفرة</label>
                        <input type="text" name="sizes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="S, M, L, XL, 42, 43">
                    </div>
                </div>
            </div>

        </div>

        <!-- العمود الأيسر: الإعدادات النفسية والذكاء -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- إعدادات العرض (Flash Sale) -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4 text-red-600 flex items-center gap-2">
                    <i data-lucide="timer" class="w-5 h-5"></i> Flash Sale
                </h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">تاريخ انتهاء العرض</label>
                    <input type="datetime-local" name="offer_end_time" class="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none">
                    <p class="text-xs text-gray-500 mt-1">سيظهر عداد تنازلي في صفحة المنتج.</p>
                </div>

                <div class="mb-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="show_stock_bar" checked class="w-4 h-4 text-red-600 rounded">
                        <span class="text-sm font-medium">إظهار شريط "الكمية محدودة"</span>
                    </label>
                </div>
            </div>

            <!-- إعدادات الكوبون -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="ticket" class="text-green-600"></i> كوبون خصم
                </h3>
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">قيمة الخصم (دج)</label>
                    <input type="number" name="coupon_value" placeholder="مثلاً: 200" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-700">رمز الكوبون</label>
                    <input type="text" name="coupon_code" placeholder="SAVE200" class="w-full px-3 py-2 border border-gray-300 rounded-lg uppercase">
                </div>
            </div>

            <!-- إعدادات الروبوت (AI) -->
            <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="bot" class="text-blue-400"></i> AI Agent
                </h3>
                
                <div class="mb-3">
                    <label class="block text-xs font-medium text-gray-400 mb-1">تعليمات خاصة (AI Instructions)</label>
                    <textarea name="ai_instructions" rows="4" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm" placeholder="مثلاً: ركز على أن التوصيل مجاني، ولا تخفض السعر."></textarea>
                </div>
                
                <div class="p-3 bg-gray-800 rounded-lg border border-gray-700">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="product_type" value="physical" checked class="w-4 h-4 text-blue-500">
                        <span class="text-sm">منتج مادي (توصيل)</span>
                    </label>
                </div>
            </div>

        </div>
    </form>
</div>

<!-- Script for Image Upload (Cloudinary Logic) -->
<script>
    // إعدادات Cloudinary الخاصة بك
    const CLOUD_NAME = "dvtuocsxs"; 
    const UPLOAD_PRESET = "DZmarket"; 

    const uploadedImages = []; // مصفوفة لتخزين الروابط

    async function handleFiles(files) {
        const gallery = document.getElementById('galleryPreview');
        const hiddenInput = document.getElementById('imagesList');
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // 1. إظهار معاينة مؤقتة (Loading)
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "aspect-square bg-gray-100 rounded-lg flex items-center justify-center animate-pulse border";
            loadingDiv.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin text-gray-400"></i>';
            gallery.appendChild(loadingDiv);
            lucide.createIcons();

            // 2. الرفع إلى Cloudinary
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.secure_url) {
                    // تحسين الرابط (Auto Quality & Format)
                    const optimizedUrl = data.secure_url.replace('/upload/', '/upload/f_auto,q_auto/');
                    
                    // تحديث المعاينة بالصورة الحقيقية
                    loadingDiv.className = "aspect-square relative group rounded-lg overflow-hidden border border-gray-200";
                    loadingDiv.innerHTML = `
                        <img src="${optimizedUrl}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center cursor-pointer text-white text-xs font-bold">تم الرفع</div>
                    `;
                    
                    // إضافة الرابط للمصفوفة
                    uploadedImages.push(optimizedUrl);
                    
                    // تحديث الحقل المخفي (ليتم إرساله للباك إند)
                    hiddenInput.value = JSON.stringify(uploadedImages);
                }
            } catch (error) {
                console.error('Upload Error:', error);
                loadingDiv.remove(); // حذف العنصر إذا فشل الرفع
                alert("فشل رفع بعض الصور، يرجى المحاولة مرة أخرى.");
            }
        }
    }
</script>
{% endblock %}
